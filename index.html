<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GMTK 2021</title>
  </head>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
      background-color: darkgray;
      min-height: 100vh;
      font-family: Arial, Helvetica, sans-serif;
    }

    #canvas {
      width: 100vmin;
      height: 100vmin;
      background-color: pink;
    }
    .hidden {
      display: none;
    }

    h2 {
      color: white;
    }
  </style>
  <body>
    <div id="startScreen">
      <h2>Press Start to Play!</h2>
      <button id="playBtn" onclick="startGame()">Start!</button>
    </div>
    <canvas id="canvas" class="hidden" width="1000" height="1000">Your browser doesn't support html5 canvas!</canvas>
    <!-- assets -->
    <img src="./assets/filler-underwater-background.jpg" id="backgroundpic" hidden />
    <img src="./assets/examplemap.png" id="cmapImg0" hidden />
  </body>
</html>
<!-- Scripts -->
<script src="collisionMap.js"></script>
<script src="camera.js"></script>
<script src="particles.js"></script>
<script src="diver.js"></script>
<script src="submarine.js"></script>
<script>
  const canvas = document.getElementById("canvas");
  ctx = canvas.getContext("2d");

  const SIZE = 1000;
  const keys = {};
  var subLives;
  var diveLives;
  var hitGrace;
  var points;
  var subTimeRemaining;
  var diveTimeRemaining;
  var oxygenTimer;
  var dead;
  let done = false;

  // inits
  let submarine = new Submarine();
  let diver = new Diver();
  let camera = new Camera();
  let particles = new Particles();

  function startGame() {
    canvas.classList.remove("hidden");
    startScreen.classList.add("hidden");
    done = false;
    // RESET GAME HERE
    console.log("starting");
    subLives = 3;
    diveLives = 3;
    hitGrace = 0;
    points = 0;
    subTimeRemaining = 60;
    diveTimeRemaining = 10;
    oxygenTimer = setInterval(countDownSeconds, 1000);
    dead = false;
    submarine.reset(0, 0);
    diver.reset(0, 0);
    tick();
  }
  function tick() {
    update();
    draw();
    if (!done) {
      requestAnimationFrame(tick);
    }
  }

  // reduce the time
  function countDownSeconds() {
    subTimeRemaining = subTimeRemaining - 1;
    if (diver.isOutOfSub == true) {
      diveTimeRemaining = diveTimeRemaining - 1;
    } else {
      diveTimeRemaining = 10;
    }
    deathByTime();
  }

  // when you run out of time
  function deathByTime() {
    if (subTimeRemaining == 0 || diveTimeRemaining == 0) {
      console.log("YOU DIED");
      window.clearInterval(oxygenTimer);
      dead = true;
    }
  }

  //when you run out of lives
  function deathByBlows() {
    if (subLives == 0 || diveLives == 0) {
      console.log("YOU DIED");
      window.clearInterval(oxygenTimer);
      dead = true;
    }
  }

  function reduceHealth() {
    if (hitGrace == 0) {
      if (diver.isOutOfSub) {
        diveLives = diveLives - 1;
      } else {
        subLives = subLives - 1;
      }
      hitGrace = hitGrace + 0.5;
      var hitTimer = setTimeout(updateHitGrace, 1000);
      deathByBlows();
    }
  }

  //determine how soon health can be reduced again
  function updateHitGrace() {
    hitGrace = hitGrace - 0.5;
  }

  function increasePoints() {
    if (diver.isOutOfSub) {
      points = points + 1;
    }
  }

  function draw() {
    ctx.save();
    ctx.clearRect(0, 0, SIZE, SIZE);

    const cameraBase = (camera.y / 10) % SIZE;
    // ctx.drawImage(backgroundpic, 0, cameraBase, SIZE, SIZE);
    // ctx.drawImage(backgroundpic, 0, cameraBase + SIZE, SIZE, SIZE);
    // ctx.translate(camera.x, camera.y);
    ctx.font = "italic 18px Arial";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "red";
    ctx.fillText("Sub Lives Left: " + subLives, 30, 25);
    ctx.fillText("Dive Lives Left: " + diveLives, 30, 50);
    ctx.fillText("Treasure Points: " + points, 30, 75);
    ctx.fillText("Sub Time Remaining: " + subTimeRemaining, 500, 25);
    ctx.fillText("Dive Time Remaining: " + diveTimeRemaining, 500, 50);

    submarine.draw(ctx);
    diver.draw(ctx);
    particles.draw(ctx);

    ctx.restore();
  }

  function update() {
    submarine.update(keys);
    diver.update(keys);
    camera.update();
    particles.update();

    //placeholder for colliding and reducing health
    if (keys["g"]) {
      reduceHealth();
    }

    //placeholder for collecting treasure
    if (keys["c"]) {
      increasePoints();
    }

    // leave sub
    if (keys["e"]) {
      if (!diver.isOutOfSub) {
        diver.isOutOfSub = true;
        diver.y = diver.y + 60;
      }
    }
    // reenters sub
    if (keys["r"] && circlesCollide(submarine.cx, submarine.cy, submarine.h / 2, diver.x, diver.y, diver.h / 2)) {
      console.log("re-enter sub");
      diver.isOutOfSub = false;
    }
    // end game
    if (keys["Escape"] || dead == true) {
      done = true;
      canvas.classList.add("hidden");
      startScreen.classList.remove("hidden");
    }
  }

  function circlesCollide(x1, y1, r1, x2, y2, r2) {
    const dx = x1 - x2;
    const dy = y1 - y2;
    const dsq = dx * dx + dy * dy;
    const rsq = (r1 + r2) * (r1 + r2);

    return dsq < rsq;
  }

  window.onkeydown = function (event) {
    // console.log(event);
    const k = event.key;
    keys[k] = true;
  };
  window.onkeyup = function (event) {
    const k = event.key;
    keys[k] = false;
  };
</script>
