<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GMTK 2021</title>
  </head>
  <script>
    var loadedImgs = 0;
    function imageLoaded() {
      loadedImgs++;
    }
  </script>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      padding: 0;
      background-color: darkgray;
      min-height: 100vh;
      font-family: Arial, Helvetica, sans-serif;
    }

    button {
      padding: 5px 10px;
      background-color: teal;
      color: white;
      border-radius: 3px;
      box-shadow: 3px 5px 5px rgba(0, 0, 0, 0.658);
      /* cursor: pointer; */
    }

    button:active {
      box-shadow: inset 1px 1px 10px #333;
    }

    #canvas {
      width: 100vmin;
      height: 100vmin;
      background-color: rgb(255, 192, 203);
    }
    .scoreCard {
      color: white;
      position: absolute;
      display: flex;
      flex-direction: column;
      left: 0;
      right: 0;
      margin-left: auto;
      margin-right: auto;
      padding: 20px;
      width: 500px;
      background-color: pink;
    }
    .goingUp {
      position: absolute;
      display: block;
      left: 0;
      right: 0;
      margin-left: auto;
      margin-right: auto;
      width: 500px;
      background-color: rgba(128, 128, 128, 0.445);
      padding: 20px;
      display: flex;
      flex-flow: column nowrap;
      justify-content: center;
      align-items: center;
    }
    .btn-group {
      display: flex;
      flex-direction: row;
      justify-content: space-evenly;
      gap: 2rem;
    }
    .hidden {
      display: none;
    }

    h2 {
      color: white;
    }
  </style>
  <body>
    <div id="startScreen">
      <h2>Press Start to Play!</h2>
      <button id="playBtn" onclick="goToMenu()" disabled>Start!</button>
    </div>
    <div id="menu" class="hidden">
      <button id="level1" value="1" onclick="startGame(1)">Level1</button>
      <button id="level2" value="2" onclick="startGame(2)">Level2</button>
      <button id="level3" value="3" onclick="startGame(3)">Level3</button>
      <button id="settingsBtn" onclick="goToSettings()">Settings</button>
    </div>
    <div id="score" class="hidden scoreCard">
      <h2>Your Score!</h2>
      <div>Loot from your dive: <span id="treasureCount"></span> Coins</div>
      <div>Dive time: <span id="diveTime"></span> Seconds</div>
      <div>
        <button id="continueBtn" onclick="goToMenu()">Continue</button>
      </div>
    </div>
    <div id="settingsScreen" class="hidden">
      <select id="difficulty">
        <option value="0" selected>Easy</option>
        <option value="1">Medium</option>
        <option value="2">Hard</option>
      </select>
      <button id="audioOnBtn" onclick="toggleAudio()" value="On">Volume On</button>
      <button id="menuBtn" onclick="goToMenu()">Back</button>
    </div>
    <div id="lossScreen" class="hidden goingUp">
      <h2>Uh Oh</h2>
      <div id="lossMsg"></div>
      <button id="lossBtn" onclick="goToMenu()">Back to Menu</button>
    </div>
    <div class="hidden goingUp" id="goingUp">
      <h2>Going Up?</h2>
      <div class="btn-group">
        <button id="goUpButton" onclick="goUp()">Up!</button>
        <button id="goDownButton" onclick="goDown()">Nope!</button>
      </div>
    </div>
    <canvas id="canvas" class="hidden" width="1000" height="1000">Your browser doesn't support html5 canvas!</canvas>
    <canvas hidden id="renderer" width="1000" height="1000"></canvas>
    <canvas hidden id="mapLoader" width="1000" height="2500"></canvas>

    <!-- assets -->
    <img src="./assets/filler-underwater-background.jpg" id="backgroundpic" hidden />
    <img src="./assets/lvl1.png" id="c_map" onload="imageLoaded()" hidden />
    <audio id="menuTune" preload="auto" src="./assets/menu v3.mp3" type="audio/mpeg" loop="true">
      Your browser does not support the audio element
    </audio>
    <audio id="subTune" preload="auto" src="./assets/in-sub v2.mp3" type="audio/mpeg"></audio>
    <audio id="diveTune" preload="auto" src="./assets/diver v2.mp3" type="audio/mpeg"></audio>
    <audio id="deathTune" preload="auto" src="./assets/drown sfx v2.mp3" type="audio/mpeg"></audio>
    <audio id="treasureTune" preload="auto" src="./assets/gold sfx v2.mp3" type="audio/mpeg"></audio>
  </body>
</html>

<!-- Scripts -->
<script src="camera.js"></script>
<script src="hud.js"></script>
<script src="particles.js"></script>
<script src="collisionMap.js"></script>
<script src="levels.js"></script>
<script src="treasure.js"></script>
<script src="fish.js"></script>
<script src="diver.js"></script>
<script src="submarine.js"></script>
<script>
  const canvas = document.getElementById("canvas");
  const renderer = document.getElementById("renderer");
  const vis_ctx = canvas.getContext("2d");
  const ctx = renderer.getContext("2d");
  document.getElementById("deathTune").loop = false;
  const SIZE = 1000;
  const MAP_H = 2500;
  const keys = {};
  var subLives;
  var hitGrace;
  var points;
  var subTimeRemaining;
  var diveTimeRemaining;
  var dead;
  var map_data;
  var paused;
  var playingAudio;
  var pausedAudio;
  var audioOn = true;
  var track = "menuTune";
  var startOver = true;
  var difficultyLevel;
  const TILES = {
    "255,174,201,255": null,
    "255,255,255,255": 0,
    "0,0,0,255": 1,
  };
  let done = false;
  let win = false;

  // inits
  let submarine = new Submarine();
  let diver = new Diver();
  let camera = new Camera();
  let hud = new HUD();
  let particles = new Particles();
  let chests = getChests(1);
  let fishes = getFishes(1);

  function goToSettings() {
    menu.classList.add("hidden");
    settingsScreen.classList.remove("hidden");
  }
  function goToMenu() {
    startScreen.classList.add("hidden");
    menu.classList.remove("hidden");
    settingsScreen.classList.add("hidden");
    score.classList.add("hidden");
    canvas.classList.add("hidden");
    lossScreen.classList.add("hidden");
    playAudio("menuTune", true);
  }
  function showScore() {
    score.classList.remove("hidden");
    startScreen.classList.add("hidden");
    menu.classList.add("hidden");
    settingsScreen.classList.add("hidden");
    canvas.classList.add("hidden");
    playAudio("menuTune", true);
    // tally
    treasureCount.innerText = points;
    diveTime.innerText = 60 - Math.floor(subTimeRemaining);
  }

  function startGame(lvl) {
    chosenLvl = lvl;
    updateDifficulty();
    canvas.classList.remove("hidden");
    startScreen.classList.add("hidden");
    menu.classList.add("hidden");
    done = false;
    // RESET GAME HERE
    console.log("starting");
    subLives = 3;
    hitGrace = 0;
    points = 0;
    subTimeRemaining = 60;
    diveTimeRemaining = 10;
    dead = false;
    submarine.reset(500, 50);
    diver.reset(500, 0);
    submarine.isGoingDown = true;
    camera.x = 0;
    camera.y = 0;
    chests = getChests(lvl);
    fishes = getFishes(lvl);
    playAudio("subTune", true);
    paused = false;
    tick();
  }

  function updateDifficulty() {
    var chosenDifficultyLevel = document.getElementById("difficulty");
    difficultyLevel = chosenDifficultyLevel.options[chosenDifficultyLevel.selectedIndex].value;
  }

  function playAudio(track, startOver) {
    if (track == "treasureTune") {
      document.getElementById(track).play();
    } else if (audioOn && playingAudio != track) {
      if (playingAudio) {
        pauseAudio(playingAudio);
      }
      var audio = document.getElementById(track);
      if (startOver) {
        audio.currentTime = 0;
      }
      audio.play();
      playingAudio = track;
    }
  }

  function pauseAudio(track) {
    var audio = document.getElementById(track);
    audio.pause();
    playingAudio = "";
    pausedAudio = track;
  }

  function toggleAudio() {
    var audioOnBtn = document.getElementById("audioOnBtn");
    if (audioOnBtn.value == "On") {
      audioOnBtn.value = "Off";
      audioOnBtn.innerText = "Volume Off";
      audioOn = false;
      pauseAudio(playingAudio);
    } else {
      audioOnBtn.value = "On";
      audioOnBtn.innerText = "Volume On";
      audioOn = true;
      playAudio(pausedAudio, true);
    }
  }

  function initMap() {
    if (loadedImgs == 1) {
      const mlctx = mapLoader.getContext("2d");
      mlctx.drawImage(c_map, 0, 0);
      map_data = getCanvasData(mlctx);
      flushToCanvas();
      clearInterval(mapInitInterval);
      playBtn.disabled = false;
    }
  }
  let mapInitInterval = setInterval(initMap, 500);

  function tick() {
    update();
    draw();
    if (!done) {
      requestAnimationFrame(tick);
    }
  }

  // reduce the time
  function countDownSeconds() {
    if (diver.isOutOfSub == true) {
      diveTimeRemaining = diveTimeRemaining - 1 / 60;
    } else {
      diveTimeRemaining = 10;
      subTimeRemaining = subTimeRemaining - 1 / 60;
    }
    deathByTime();
  }

  // when you run out of time
  function deathByTime() {
    if (subTimeRemaining <= 0 || diveTimeRemaining <= 0) {
      console.log("YOU DIED");
      done = true;
      lossScreen.classList.remove("hidden");
      lossMsg.innerText = "You ran out of time";
      dead = true;
    }
  }

  //when you run out of lives
  function deathByBlows() {
    if (subLives == 0) {
      dead = true;
    }
  }

  function reduceHealth() {
    if (hitGrace == 0 && submarine.takingDamage) {
      subLives = subLives - difficultyLevel;
      hitGrace = hitGrace + 0.5;
      var hitTimer = setTimeout(updateHitGrace, 1000);
      deathByBlows();
    }
  }

  //determine how soon health can be reduced again
  function updateHitGrace() {
    hitGrace = hitGrace - 0.5;
  }

  function increasePoints(amt) {
      points += amt;
      playAudio("treasureTune", true)
  }

  function increaseSpeed(amt, entity){
    if (entity == "sub") {
      submarine.speed += amt/2;
    }
    else{diver.speed += amt/2;}
    playAudio("treasureTune", true)
  }

  function draw() {
    ctx.clearRect(0, 0, SIZE, SIZE);
    ctx.save();

    const cameraBase = (camera.y / 10) % MAP_H;
    // ctx.drawImage(backgroundpic, 0, cameraBase, SIZE, MAP_H);
    // ctx.drawImage(backgroundpic, 0, 0 + SIZE, SIZE, SIZE);
    ctx.translate(camera.x, camera.y);
    ctx.drawImage(c_map, 0, 0, SIZE, MAP_H);

    submarine.draw(ctx);
    diver.draw(ctx);
    particles.draw(ctx);
    chests.forEach((chest, idx) => chest.draw(ctx));
    fishes.forEach((fish, idx) => fish.draw(ctx));
    hud.draw(ctx);

    ctx.restore();
  }

  function update() {
    if (paused) return;
    submarine.update(keys);
    if (paused) return;
    diver.update(keys);
    if (paused) return;
    camera.update();
    particles.update();
    countDownSeconds();
    reduceHealth();
    if (diver.isOutOfSub) {
      playAudio("diveTune", true);
    } else {
      playAudio("subTune", false);
    }

    chests.forEach((chest, idx) => {
      chest.update();
      if (diver.isOutOfSub && circlesCollide(diver.cx, diver.cy, diver.h / 2, chest.x, chest.y, chest.r)) {
        increasePoints(chest.loot);
        chests.splice(idx, 1);
      }
    });

    fishes.forEach((fish, idx) => {
      fish.update();
      if (diver.isOutOfSub && circlesCollide(diver.cx, diver.cy, diver.h / 2, fish.x, fish.y, fish.r)) {
        increaseSpeed(fish.increase, fish.entity);
        fishes.splice(idx, 1);
      }
    });

    // end game
    if (keys["Escape"]) {
      done = true;
      goToMenu();
    }

    // win
    if (submarine.y <= 0 && subTimeRemaining > 0) {
      win = true;
      done = true;
      showScore();
    }

    //trigger switch prompt
    if (keys["q"] && submarine.isGoingDown) {
      switchDirectionsPrompt();
      keys["q"] = false;
    }
    //lose
    if (dead) {
      if (diver.isOutOfSub || subLives == 0) {playAudio("deathTune", true);}
      console.log("YOU DIED");
      done = true;
      lossScreen.classList.remove("hidden");
    }
  }

  function switchDirectionsPrompt() {
    paused = true;
    pauseAudio(playingAudio);
    goingUp.classList.remove("hidden");
  }
  function goUp() {
    submarine.isGoingDown = false;
    goingUp.classList.add("hidden");
    paused = false;
    playAudio(pausedAudio, false);
  }
  function goDown() {
    submarine.isGoingDown = true;
    goingUp.classList.add("hidden");
    paused = false;
    playAudio(pausedAudio, false);
  }

  function circlesCollide(x1, y1, r1, x2, y2, r2) {
    const dx = x1 - x2;
    const dy = y1 - y2;
    const dsq = dx * dx + dy * dy;
    const rsq = (r1 + r2) * (r1 + r2);
    return dsq < rsq;
  }

  window.onkeydown = function (event) {
    const k = event.key;
    keys[k] = true;
  };
  window.onkeyup = function (event) {
    const k = event.key;
    keys[k] = false;
  };
</script>
